<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="css/home-style.css">
    <script src="https://kit.fontawesome.com/eabac940d1.js" crossorigin="anonymous"></script>
</head>
<body>
<script src="/js/script.js"></script>
<script>
    document.getElementById('clear-notifications').addEventListener('click', function() {
        fetch('/clear-notifications', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // If successful, clear notifications in the DOM
                    document.getElementById('notification-list').innerHTML = '<li>No new notifications</li>';
                    document.querySelector('.notification-badge').style.display = 'none'; // Hide the badge
                }
            });
    });
</script>

<nav>
    <div class="logo"><a href="/home">CampusNexus</a></div>
    <div class="search">
        <!-- Search form remains the same -->
    </div>

    <div class="nav-items">
        <ul>
            <li><a href="/home">Home</a></li>
            <% if(user==="admin"){ %>
                <li><a href="/admin">Dashboard</a></li>
            <% } %>
            <li class="subscription-cta">
                <a href="/subscriptions" class="btn-subscribe">Manage Subscriptions</a>
            </li>
            <li><a href="/ai-agent" class="btn-agent">AI Agent</a></li>
            <!-- Add notification bell icon here -->
            <li class="notification-icon">
                <a href="#" id="notification-bell">
                    <i class="fa-solid fa-bell"></i>
                    <% if (notifications.length > 0) { %>
                        <span class="notification-badge"><%= notifications.length %></span>
                    <% } %>
                </a>
            </li>
        </ul>
    </div>

    <!-- Hamburger Menu Icon -->
    <div class="hamburger-menu">
        <i class="fa-solid fa-bars"></i>
    </div>

    <!-- Notification Popup (Positioned Inside Navbar) -->
    <div id="notification-popup" class="hidden">
        <div class="popup-content">
            <span class="close-popup">&times;</span>
            <h2>Notifications</h2>
            <ul id="notification-list">
                <% if (notifications.length > 0) { %>
                    <% notifications.forEach(notification => { %>
                        <li>
                            <a href="/posts/<%= notification.postId %>"><%= notification.message %></a>
                        </li>
                    <% }) %>
                <% } else { %>
                    <li id="no-notifications">No new notifications</li>
                <% } %>
            </ul>
            <% if (notifications.length > 0) { %>
                <button id="clear-notifications">Clear All</button>
            <% } %>
        </div>
    </div>
</nav>

<!-- Sidebar Menu for Desktop -->
<div id="desktop-menu" class="desktop-menu">
    <div class="desktop-menu-header">
        <span class="close-desktop-menu">&times;</span>
    </div>
    <ul>
        <li><a href="/profile/<%= user %>">My Profile</a></li>
        <li><a href="/logout">Logout</a></li>
    </ul>
</div>

<main>
    <div class="pop-posts-container">
        <h1>Popular Articles <a href="/compose"><button><i class="fa-sharp fa-solid fa-pen"></i>&nbsp; Compose</button></a></h1>

        <div class="pop-posts">
            <% if(sposts){ %>
                <% sposts.forEach((sposts)=>{ %>
                    <div class="post-box">
                        <img src="thumbnails/<%= sposts.thumbnail %>" alt="" onerror="this.onerror=null; this.src='images/default-image.png'">
                        <div class="middle">
                            <a href="/posts/<%= sposts._id %>">Read More</a>
                        </div>
                        <h2><%= sposts.title %></h2>
                        <p><%= sposts.content %></p>
                    </div>
                <% }) %>
            <% } %>
        </div>
    </div>

    <div class="recent-posts-container">
        <h1>Recent Articles</h1>
        <div class="recent-posts">
            <% posts.reverse().forEach((posts)=>{ %>
                <div class="recent-post-box">
                    <a href="/posts/<%= posts._id %>" class="link-card">
                        <div class="img-container">
                            <div>
                                <img src="thumbnails/<%= posts.thumbnail %>" alt="" onerror="this.onerror=null; this.src='images/default-image.png'">
                            </div>
                        </div>
                        <% var days = Math.round((date - posts.date) / 86400000)
                            if(days === 0){
                                days = Math.round((date - posts.date) / 3600000)
                                if(days === 0){
                                    days = Math.round((date - posts.date) / 60000)
                                    if(days === 0){
                                        days = "Just now"
                                    } else if(days === 1){
                                        days = "1 minute ago"
                                    } else {
                                        days = days + " minutes ago"
                                    }
                                } else if(days === 1){
                                    days = "1 hour ago"
                                } else {
                                    days = days + " hours ago"
                                }
                            } else if(days === 1){
                                days = "1 day ago"
                            } else {
                                days = days + " days ago"
                            } %>
                        <p class="days"><%= days %></p>
                        <h2 title="<%= posts.title %>"><%= posts.title %></h2>
                        <p class="post-desc">
                            <%= posts.content %>
                        </p>
                        <div class="post-footer">
                            <p><%= posts.author %></p>
                            <button>ReadMore</button>
                        </div>
                    </a>
                </div>
            <% }) %>
        </div>
    </div>
</main>

<script>
    function sendData(e){
        const searchResults = document.getElementById("searchDiv");
        if(e.value.length != 0){
            document.getElementById("reset-btn").style.display = "block";
        } else {
            document.getElementById("reset-btn").style.display = "none";
        }

        let match = e.value.match(/^[a-z A-Z]*/);
        let match2 = e.value.match(/\s*/);
        if(match2[0] === e.value){
            searchResults.innerHTML = '';
            return;
        }
        if(match[0] === e.value){
            fetch('search',{
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({payload: e.value})
            }).then(res => res.json()).then(data => {
                let payload = data.payload;
                searchResults.innerHTML = '';
                if(payload.length < 1){
                    searchResults.innerHTML = '<p>Sorry nothing found.</p>';
                    return;
                }
                payload.forEach((PosT, index) => {
                    if(index > 0) searchResults.innerHTML += '';
                    searchResults.innerHTML += `<p><a href="/posts/${PosT._id}" onmouseover="suggest(this)" id="data">${PosT.title}</a></p>`;
                });
            });
            return;
        }
        searchResults.innerHTML = '';
    }

    function suggest(e){
        document.getElementById("search").value = e.innerHTML;
    }
</script>
</body>
</html>
